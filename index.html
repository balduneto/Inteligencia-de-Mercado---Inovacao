<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Inteligência de Mercado</title>
    
    <!-- 1. TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React e ReactDOM -->
    <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- 3. Prop-Types (Necessário para Recharts) -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>

    <!-- 4. Recharts -->
    <script src="https://unpkg.com/recharts@2.12.0/umd/Recharts.js"></script>
    
    <!-- 5. Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        body {
            background-color: #f8fafc;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. Globais ---
        const { useState, useMemo, useRef, useEffect } = React;
        
        // Acesso seguro ao Recharts
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            PieChart, Pie, Cell, ScatterChart, Scatter, ZAxis, Radar, RadarChart, PolarGrid, 
            PolarAngleAxis, PolarRadiusAxis, Treemap 
        } = window.Recharts;

        // --- 2. Ícones (Definidos manualmente para eliminar erros de dependência externa) ---
        const Icons = {
            Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>,
            ArrowRight: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>,
            Briefcase: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            DollarSign: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            FileText: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            Filter: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>,
            Layers: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>,
            MapPin: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
            RefreshCw: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Search: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            ShoppingCart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>,
            Star: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>,
            TrendingUp: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M8 21h8m-4-9v9m-4.8-9a3 3 0 1 0-4.2-4.2 3 3 0 0 0 4.2 4.2zm13.6 0a3 3 0 1 0-4.2-4.2 3 3 0 0 0 4.2 4.2z"></path><path d="M6 9h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1z"></path></svg>,
            Upload: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Zap: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>
        };

        const { 
            TrendingUp, Users, ShoppingCart, RefreshCw, 
            ArrowRight, Activity, Zap, Layers, Upload, FileText, Search, X, Star, Briefcase, Trophy, DollarSign, Calendar, MapPin, Filter 
        } = Icons;

        // --- 3. Constantes e Dados Iniciais ---
        const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8', '#82ca9d', '#ffc658', '#8dd1e1', '#a4de6c', '#d0ed57'];

        const INITIAL_DATA = [
            { id: 1444132, date: "31/12/2025", year: "2025", client: "COOPERATIVA HABITACIONAL GRAN PARQUE", revenue: 48000.00, line: "METROLOGIA", category: "ENSAIOS", product: "Moldagem e Ruptura de Corpos de Prova", unit: "ESCOLA SENAI DE VILA CANAÃ" },
            { id: 1444152, date: "30/12/2025", year: "2025", client: "INCORPORACAO 41 BRASAL", revenue: 80028.00, line: "METROLOGIA", category: "ENSAIOS", product: "Moldagem e Ruptura de Corpos de Prova", unit: "ESCOLA SENAI DE VILA CANAÃ" },
            { id: 989087, date: "28/12/2024", year: "2024", client: "RADIADORES RADIAL", revenue: 13333.33, line: "CONSULTORIA EM TECNOLOGIA", category: "CONSULTORIA EM PROCESSOS PRODUTIVOS", product: "MOVER Hands-On", unit: "IST AUTOMAÇÃO GO" },
            { id: 1297889, date: "28/03/2025", year: "2025", client: "REVESTICAR", revenue: 30000.00, line: "CONSULTORIA EM TECNOLOGIA", category: "CONSULTORIA EM PROCESSOS PRODUTIVOS", product: "MOVER Hands-On", unit: "IST AUTOMAÇÃO GO" },
            { id: 648392, date: "28/01/2023", year: "2023", client: "SEBRAE GO", revenue: 7452.00, line: "METROLOGIA", category: "ENSAIOS BIOLÓGICOS", product: "Ensaios Microbiológicos", unit: "IST ALIMENTOS E BEBIDAS GO" },
            { id: 646222, date: "28/01/2023", year: "2023", client: "CIELT S/A INDUSTRIA E MONTAGENS", revenue: 25000.00, line: "METROLOGIA", category: "ENSAIOS", product: "Ensaio por Liquido Penetrante", unit: "ESCOLA SENAI DR CELSO CHARURI" },
        ];

        // --- 4. Helpers ---
        const parseCSVLine = (text) => {
            const result = [];
            let cell = '';
            let inQuotes = false;
            for (let i = 0; i < text.length; i++) {
                const char = text[i];
                if (char === '"') { inQuotes = !inQuotes; }
                else if (char === ';' && !inQuotes) { result.push(cell.trim()); cell = ''; }
                else { cell += char; }
            }
            result.push(cell.trim());
            return result;
        };

        const parseCurrency = (str) => {
            if (!str) return 0;
            const cleanStr = str.replace(/[R$\s.]/g, '').replace(',', '.');
            const val = parseFloat(cleanStr);
            return isNaN(val) ? 0 : val;
        };

        const extractClientName = (rawName) => {
            if (!rawName) return "DESCONHECIDO";
            const cleanRaw = rawName.replace(/"/g, '');
            const parts = cleanRaw.split(';');
            const clientParts = parts.filter(p => {
                const upper = p.toUpperCase();
                return !upper.includes('SENAI') && !upper.includes('ESCOLA') && !upper.includes('INSTITUTO SENAI');
            });
            if (clientParts.length > 0) return clientParts[0].trim();
            return parts[0].trim();
        };

        const formatBRL = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);

        // --- 5. Componente Principal ---
        function MarketIntelligenceDashboard() {
            const [activeTab, setActiveTab] = useState('overview');
            const [transactions, setTransactions] = useState(INITIAL_DATA);
            const [fileName, setFileName] = useState("Dados de Amostra (Arquivo Atual)");
            const [selectedClient, setSelectedClient] = useState(null);
            
            const [filters, setFilters] = useState({
                unit: 'all', year: 'all', category: 'all', product: 'all'
            });

            const fileInputRef = useRef(null);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setFileName(file.name);
                const reader = new FileReader();
                reader.onload = (e) => { processFile(e.target.result); };
                reader.readAsText(file);
            };

            const processFile = (csvText) => {
                try {
                    const lines = csvText.split('\n').filter(l => l.trim().length > 0);
                    if (lines.length < 2) return;

                    const headers = parseCSVLine(lines[0].toUpperCase());
                    
                    const idxClient = headers.findIndex(h => h.includes('NOME EMPRESA'));
                    const idxRevenue = headers.findIndex(h => h.includes('RECEITA')); 
                    const idxLine = headers.findIndex(h => h.includes('PRODUTO LINHA'));
                    const idxCategory = headers.findIndex(h => h.includes('PRODUTO CATEGORIA'));
                    const idxProduct = headers.findIndex(h => h.includes('PRODUTO REGIONAL'));
                    const idxUnit = headers.findIndex(h => h.includes('UNIDADE'));
                    const idxDate = headers.findIndex(h => h === 'DATA' || h === 'DATA;'); 

                    const parsedData = lines.slice(1).map((line, index) => {
                        const cols = parseCSVLine(line);
                        if (cols.length < 5) return null;

                        const dateStr = idxDate > -1 ? cols[idxDate] : '';
                        let year = 'N/A';
                        if (dateStr && dateStr.includes('/')) {
                            year = dateStr.split('/')[2];
                        }

                        return {
                            id: index,
                            client: extractClientName(cols[idxClient]),
                            revenue: idxRevenue > -1 ? parseCurrency(cols[idxRevenue]) : 0,
                            line: idxLine > -1 ? cols[idxLine] : 'GERAL',
                            category: idxCategory > -1 ? cols[idxCategory] : 'GERAL',
                            product: idxProduct > -1 ? cols[idxProduct] : 'Desconhecido',
                            unit: idxUnit > -1 ? cols[idxUnit] : 'N/A',
                            date: dateStr,
                            year: year
                        };
                    }).filter(Boolean);

                    setTransactions(parsedData);
                    setFilters({ unit: 'all', year: 'all', category: 'all', product: 'all' });
                    setActiveTab('overview');
                } catch (err) {
                    console.error(err);
                    alert("Erro ao processar arquivo. Verifique se o formato é CSV separado por ponto-e-vírgula (;).");
                }
            };

            const filteredTransactions = useMemo(() => {
                return transactions.filter(t => {
                    const matchUnit = filters.unit === 'all' || t.unit === filters.unit;
                    const matchYear = filters.year === 'all' || t.year === filters.year;
                    const matchCategory = filters.category === 'all' || t.category === filters.category;
                    const matchProduct = filters.product === 'all' || t.product === filters.product;
                    return matchUnit && matchYear && matchCategory && matchProduct;
                });
            }, [transactions, filters]);

            const filterOptions = useMemo(() => {
                const units = new Set();
                const years = new Set();
                const categories = new Set();
                const products = new Set();

                transactions.forEach(t => {
                    if (t.unit) units.add(t.unit);
                    if (t.year) years.add(t.year);
                    if (t.category) categories.add(t.category);
                    if (t.product) products.add(t.product);
                });

                return {
                    units: Array.from(units).sort(),
                    years: Array.from(years).sort().reverse(),
                    categories: Array.from(categories).sort(),
                    products: Array.from(products).sort()
                };
            }, [transactions]);

            const analytics = useMemo(() => {
                if (!filteredTransactions.length) return null;

                let totalRevenue = 0;
                let totalContracts = filteredTransactions.length;
                const clientMap = {};
                const productLineStats = {};
                const unitStats = {};
                const allUniqueLines = new Set();

                filteredTransactions.forEach(t => {
                    totalRevenue += t.revenue;
                    allUniqueLines.add(t.line);

                    if (!productLineStats[t.line]) productLineStats[t.line] = { name: t.line, revenue: 0, count: 0 };
                    productLineStats[t.line].revenue += t.revenue;
                    productLineStats[t.line].count += 1;

                    if (!unitStats[t.unit]) unitStats[t.unit] = { name: t.unit, value: 0 };
                    unitStats[t.unit].value += t.revenue;

                    if (!clientMap[t.client]) {
                        clientMap[t.client] = {
                            name: t.client, revenue: 0, count: 0, lines: new Set(), lineCounts: {}, products: {}
                        };
                    }
                    clientMap[t.client].revenue += t.revenue;
                    clientMap[t.client].count += 1;
                    clientMap[t.client].lines.add(t.line);
                    clientMap[t.client].lineCounts[t.line] = (clientMap[t.client].lineCounts[t.line] || 0) + 1;
                    clientMap[t.client].products[t.product] = (clientMap[t.client].products[t.product] || 0) + 1;
                });

                const clients = Object.values(clientMap).map(c => ({
                    ...c, ticket: c.revenue / c.count, lineCount: c.lines.size, linesArray: Array.from(c.lines)
                }));

                const topRevenueClients = [...clients].sort((a, b) => b.revenue - a.revenue).slice(0, 10);
                
                const topCrossSellClients = [...clients]
                    .filter(c => c.lineCount > 1)
                    .sort((a, b) => {
                        if (b.lineCount !== a.lineCount) return b.lineCount - a.lineCount;
                        return b.count - a.count;
                    })
                    .slice(0, 50);

                const revenueByLine = Object.values(productLineStats).sort((a, b) => b.revenue - a.revenue);
                
                const clientVolumeChartData = [...clients]
                    .sort((a, b) => b.count - a.count)
                    .slice(0, 15)
                    .map(c => {
                        const dataPoint = { name: c.name, total: c.count };
                        Object.entries(c.lineCounts).forEach(([line, count]) => { dataPoint[line] = count; });
                        return dataPoint;
                    });

                const matrix = {};
                clients.forEach(c => {
                    const cProducts = Object.keys(c.products);
                    for (let i = 0; i < cProducts.length; i++) {
                        for (let j = i + 1; j < cProducts.length; j++) {
                            const key = [cProducts[i], cProducts[j]].sort().join(' + ');
                            if (!matrix[key]) matrix[key] = { name: key, count: 0, value: 0 };
                            matrix[key].count++;
                            matrix[key].value += c.revenue;
                        }
                    }
                });
                const topBundles = Object.values(matrix).sort((a, b) => b.count - a.count).slice(0, 8);

                return {
                    totalRevenue, totalContracts, avgTicket: totalContracts > 0 ? totalRevenue / totalContracts : 0,
                    clients, topRevenueClients, topCrossSellClients, revenueByLine, topBundles,
                    uniqueClients: clients.length, unitChart: Object.values(unitStats).sort((a,b) => b.value - a.value).slice(0, 5),
                    clientVolumeChartData, allUniqueLines: Array.from(allUniqueLines)
                };
            }, [filteredTransactions]);

            const clientDetail = useMemo(() => {
                if (!selectedClient || !analytics) return null;
                const cData = analytics.clients.find(c => c.name === selectedClient.name);
                if (!cData) return null;
                const boughtLines = Array.from(cData.lines);
                const recommendations = analytics.revenueByLine
                    .filter(l => !boughtLines.includes(l.name))
                    .slice(0, 3)
                    .map(l => ({ type: 'Segmento', name: l.name, reason: 'Alta demanda' }));
                return { ...cData, recommendations };
            }, [selectedClient, analytics]);

            return (
                <div className="min-h-screen font-sans text-slate-800 p-4 md:p-8">
                    <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-slate-200">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-3 rounded-lg text-white"><Activity className="w-6 h-6" /></div>
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">Inteligência de Mercado</h1>
                                <p className="text-sm text-slate-500">Análise de Portfólio, Receita e Mix</p>
                            </div>
                        </div>
                        <div className="flex gap-2 w-full md:w-auto">
                            <button onClick={() => fileInputRef.current.click()} className="bg-slate-900 hover:bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 transition-all shadow-md w-full md:w-auto justify-center">
                                <Upload className="w-4 h-4" /> Carregar CSV
                            </button>
                            <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                        </div>
                    </header>

                    <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6">
                        <div className="flex items-center gap-2 mb-3 text-slate-700 font-bold text-sm uppercase"><Filter className="w-4 h-4" /> Filtros Globais</div>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">Unidade</label>
                                <select className="w-full text-sm border-slate-200 rounded-lg bg-slate-50 p-2" value={filters.unit} onChange={(e) => setFilters({...filters, unit: e.target.value})}>
                                    <option value="all">Todas as Unidades</option>
                                    {filterOptions.units.map(u => <option key={u} value={u}>{u}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">Ano</label>
                                <select className="w-full text-sm border-slate-200 rounded-lg bg-slate-50 p-2" value={filters.year} onChange={(e) => setFilters({...filters, year: e.target.value})}>
                                    <option value="all">Todos os Anos</option>
                                    {filterOptions.years.map(y => <option key={y} value={y}>{y}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">Categoria</label>
                                <select className="w-full text-sm border-slate-200 rounded-lg bg-slate-50 p-2" value={filters.category} onChange={(e) => setFilters({...filters, category: e.target.value})}>
                                    <option value="all">Todas as Categorias</option>
                                    {filterOptions.categories.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-500 mb-1">Produto Regional</label>
                                <select className="w-full text-sm border-slate-200 rounded-lg bg-slate-50 p-2" value={filters.product} onChange={(e) => setFilters({...filters, product: e.target.value})}>
                                    <option value="all">Todos os Produtos</option>
                                    {filterOptions.products.map(p => <option key={p} value={p}>{p.substring(0, 30)}...</option>)}
                                </select>
                            </div>
                            <div className="flex items-end">
                                <button onClick={() => setFilters({unit: 'all', year: 'all', category: 'all', product: 'all'})} className="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 text-sm font-bold py-2 rounded-lg transition-colors flex items-center justify-center gap-1 border border-slate-200">
                                    <X className="w-4 h-4" /> Limpar
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="flex overflow-x-auto gap-2 mb-6 pb-2">
                        {[{ id: 'overview', label: 'Visão Geral & Finanças', icon: DollarSign }, { id: 'segments', label: 'Segmentos & Linhas', icon: Layers }, { id: 'cross', label: 'Cross-Sell & Oportunidades', icon: RefreshCw }, { id: 'client', label: 'Raio-X do Cliente', icon: Search }].map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-5 py-3 rounded-full text-sm font-bold whitespace-nowrap transition-all ${activeTab === tab.id ? 'bg-blue-600 text-white shadow-lg' : 'bg-white text-slate-600 hover:bg-slate-100 border border-slate-200'}`}>
                                <tab.icon className="w-4 h-4" /> {tab.label}
                            </button>
                        ))}
                    </div>

                    {!analytics ? (
                        <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed border-slate-200">
                            <div className="max-w-md mx-auto">
                                <Filter className="w-12 h-12 text-slate-300 mx-auto mb-4" />
                                <h3 className="text-lg font-medium text-slate-600">Sem resultados para este filtro</h3>
                                <button onClick={() => setFilters({unit: 'all', year: 'all', category: 'all', product: 'all'})} className="mt-4 text-blue-600 font-bold text-sm">Limpar Filtros</button>
                            </div>
                        </div>
                    ) : (
                        <div className="space-y-6 animate-in fade-in duration-500">
                            {activeTab === 'overview' && (
                                <>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative overflow-hidden">
                                            <div className="absolute right-0 top-0 p-4 opacity-5"><DollarSign className="w-24 h-24 text-blue-600" /></div>
                                            <p className="text-sm font-medium text-slate-500">Faturamento Filtrado</p>
                                            <h3 className="text-3xl font-bold text-slate-900 mt-2">{formatBRL(analytics.totalRevenue)}</h3>
                                            <div className="flex items-center mt-4 text-xs font-medium text-green-600 bg-green-50 px-2 py-1 rounded w-fit"><TrendingUp className="w-3 h-3 mr-1" /> Receita Global</div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                            <p className="text-sm font-medium text-slate-500">Ticket Médio</p>
                                            <h3 className="text-3xl font-bold text-slate-900 mt-2">{formatBRL(analytics.avgTicket)}</h3>
                                            <p className="text-xs text-slate-400 mt-2">Por contrato emitido</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                            <p className="text-sm font-medium text-slate-500">Total de Contratos</p>
                                            <h3 className="text-3xl font-bold text-slate-900 mt-2">{analytics.totalContracts}</h3>
                                            <div className="flex items-center mt-2 text-xs text-blue-600"><Briefcase className="w-3 h-3 mr-1" /> {analytics.uniqueClients} Clientes</div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                            <p className="text-sm font-medium text-slate-500">Top Unidade</p>
                                            <h3 className="text-lg font-bold text-slate-900 mt-2 truncate" title={analytics.unitChart[0]?.name}>{analytics.unitChart[0]?.name || '-'}</h3>
                                            <p className="text-xs text-slate-400 mt-2">Maior volume</p>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <div className="flex justify-between items-center mb-6">
                                            <div><h3 className="font-bold text-lg text-slate-800">Ranking de Volume por Cliente</h3><p className="text-sm text-slate-500">Top 15 empresas com mais contratos, destacando o mix.</p></div>
                                        </div>
                                        <div className="h-96 w-full">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={analytics.clientVolumeChartData} layout="vertical" margin={{ top: 10, right: 30, left: 20, bottom: 5 }}>
                                                    <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                                                    <XAxis type="number" />
                                                    <YAxis dataKey="name" type="category" width={180} tick={{fontSize: 11}} />
                                                    <Tooltip contentStyle={{ borderRadius: '8px' }} itemStyle={{ fontSize: '12px' }} />
                                                    <Legend wrapperStyle={{ fontSize: '11px', paddingTop: '10px' }} />
                                                    {analytics.allUniqueLines.map((line, index) => (
                                                        <Bar key={line} dataKey={line} stackId="a" fill={COLORS[index % COLORS.length]} name={line} radius={[0, 2, 2, 0]} />
                                                    ))}
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                            <h3 className="font-bold text-lg text-slate-800 mb-6">Receita por Linha</h3>
                                            <div className="h-80">
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <BarChart data={analytics.revenueByLine} layout="vertical" margin={{ left: 20 }}>
                                                        <CartesianGrid strokeDasharray="3 3" horizontal={true} vertical={false} />
                                                        <XAxis type="number" tickFormatter={(val) => `R$${val/1000}k`} />
                                                        <YAxis dataKey="name" type="category" width={140} tick={{fontSize: 11}} />
                                                        <Tooltip formatter={(val) => formatBRL(val)} contentStyle={{borderRadius: '8px'}} />
                                                        <Bar dataKey="revenue" fill="#3B82F6" radius={[0, 4, 4, 0]} barSize={24} />
                                                    </BarChart>
                                                </ResponsiveContainer>
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                                            <h3 className="font-bold text-lg text-slate-800 mb-4 flex items-center gap-2"><Trophy className="w-5 h-5 text-yellow-500" /> Top Receita (Pareto)</h3>
                                            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar" style={{maxHeight: '300px'}}>
                                                {analytics.topRevenueClients.map((client, i) => (
                                                    <div key={i} className="flex items-center justify-between py-3 border-b border-slate-50 last:border-0 hover:bg-slate-50 px-2 rounded transition-colors">
                                                        <div className="flex-1 min-w-0 mr-3"><p className="text-sm font-bold text-slate-700 truncate">{client.name}</p><p className="text-xs text-slate-400">{client.count} contratos</p></div>
                                                        <div className="text-right"><p className="text-sm font-bold text-emerald-600">{formatBRL(client.revenue)}</p></div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </>
                            )}
                            {activeTab === 'segments' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <h3 className="font-bold text-lg mb-2">Share de Faturamento</h3>
                                        <div className="h-80">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <PieChart>
                                                    <Pie data={analytics.revenueByLine} innerRadius={60} outerRadius={100} paddingAngle={5} dataKey="revenue">
                                                        {analytics.revenueByLine.map((entry, index) => <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />)}
                                                    </Pie>
                                                    <Tooltip formatter={(val) => formatBRL(val)} />
                                                    <Legend />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <h3 className="font-bold text-lg mb-2">Share de Volume</h3>
                                        <div className="h-80">
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={analytics.revenueByLine} margin={{top: 20, bottom: 20}}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="name" tick={false} /> <YAxis /> <Tooltip />
                                                    <Bar dataKey="count" fill="#82ca9d" name="Qtd Contratos" radius={[4, 4, 0, 0]} />
                                                    <Legend />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'cross' && (
                                <div className="space-y-6">
                                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <div className="lg:col-span-2 bg-gradient-to-br from-indigo-900 to-slate-900 text-white p-8 rounded-xl shadow-xl">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="bg-white/10 p-2 rounded-lg"><Layers className="w-6 h-6 text-indigo-400" /></div>
                                                <div><h3 className="text-xl font-bold">Matriz de Oportunidade</h3><p className="text-indigo-200 text-sm">Combos de Produtos Regionais</p></div>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                                {analytics.topBundles.map((bundle, i) => (
                                                    <div key={i} className="bg-white/5 border border-white/10 p-4 rounded-lg hover:bg-white/10 transition-colors flex flex-col justify-between min-h-[140px]">
                                                        <div>
                                                            <div className="text-xs text-indigo-300 mb-2 font-medium uppercase tracking-wider">Combo #{i+1}</div>
                                                            <div className="text-sm font-bold text-white mb-3 leading-snug">
                                                                {bundle.name.split(' + ').map((part, idx) => (
                                                                    <span key={idx} className="block mb-1 last:mb-0">
                                                                        {idx > 0 && <span className="text-indigo-400 mr-1 text-xs">+</span>}
                                                                        {part}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                        <div className="flex justify-between items-end border-t border-white/10 pt-2 mt-auto">
                                                            <span className="text-xs text-slate-400">{bundle.count} clientes</span>
                                                            <span className="text-xs font-bold text-green-400">{formatBRL(bundle.value)}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100 flex flex-col">
                                            <h3 className="font-bold text-lg text-slate-800 mb-4">Benchmarks de Mix</h3>
                                            <p className="text-sm text-slate-500 mb-4">Empresas mais diversificadas (Qtd Linhas > Volume).</p>
                                            <div className="flex-1 overflow-y-auto pr-2 custom-scrollbar" style={{maxHeight: '600px'}}>
                                                {analytics.topCrossSellClients.map((client, i) => (
                                                    <div key={i} className="mb-3 p-3 bg-slate-50 rounded border border-slate-100">
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div className="flex-1 mr-2">
                                                                <span className="font-bold text-sm text-slate-700 block leading-tight">{client.name}</span>
                                                                <span className="text-[10px] text-slate-400 font-medium block mt-1">{client.count} contratos totais</span>
                                                            </div>
                                                            <span className="text-xs bg-indigo-100 text-indigo-700 font-bold px-2 py-1 rounded-lg whitespace-nowrap h-fit">{client.lineCount} Linhas</span>
                                                        </div>
                                                        <div className="mt-2 grid grid-cols-1 gap-1">
                                                            {client.linesArray.sort((a,b) => client.lineCounts[b] - client.lineCounts[a]).map((l, idx) => (
                                                                <div key={idx} className="flex justify-between items-center text-xs bg-white border border-slate-200 px-2 py-1 rounded text-slate-600">
                                                                    <span className="mr-2 flex-1" title={l}>{l}</span>
                                                                    <span className="font-bold bg-slate-100 px-1.5 rounded text-slate-800">{client.lineCounts[l]} un.</span>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}
                            {activeTab === 'client' && (
                                <div className="space-y-6">
                                    <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                        <label className="block text-sm font-bold text-slate-700 mb-2">Buscar Cliente</label>
                                        <div className="relative">
                                            <Search className="absolute left-3 top-3 w-5 h-5 text-slate-400" />
                                            <select className="w-full pl-10 pr-4 py-3 border border-slate-200 rounded-lg appearance-none focus:ring-2 focus:ring-blue-500 outline-none bg-slate-50" onChange={(e) => { const c = analytics.clients.find(cl => cl.name === e.target.value); setSelectedClient(c); }}>
                                                <option value="">Selecione na lista...</option>
                                                {analytics.clients.sort((a,b) => a.name.localeCompare(b.name)).map((c, i) => <option key={i} value={c.name}>{c.name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {clientDetail && (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 animate-in slide-in-from-bottom-4">
                                            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                                                <div className="flex justify-between items-start mb-6">
                                                    <div>
                                                        <h2 className="text-xl font-bold text-slate-900">{clientDetail.name}</h2>
                                                        <div className="flex items-center gap-2 mt-1">
                                                            <span className="px-2 py-0.5 bg-blue-100 text-blue-700 text-xs font-bold rounded">{clientDetail.count} Contratos</span>
                                                            <span className="px-2 py-0.5 bg-green-100 text-green-700 text-xs font-bold rounded">Ticket: {formatBRL(clientDetail.ticket)}</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right"><p className="text-xs text-slate-400 uppercase font-bold">Investimento Total</p><p className="text-2xl font-bold text-emerald-600">{formatBRL(clientDetail.revenue)}</p></div>
                                                </div>
                                                <div className="space-y-4">
                                                    <h4 className="font-bold text-sm text-slate-700 border-b pb-2">Linhas Contratadas</h4>
                                                    {clientDetail.linesArray.map((line, i) => (
                                                        <div key={i} className="flex justify-between items-center text-sm">
                                                            <span className="text-slate-600">{line}</span>
                                                            <div className="flex-1 mx-4 h-2 bg-slate-100 rounded-full overflow-hidden"><div className="h-full bg-blue-500 w-full opacity-50"></div></div>
                                                            <Activity className="w-4 h-4 text-blue-400" />
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="bg-gradient-to-br from-amber-50 to-orange-50 border border-amber-100 p-6 rounded-xl">
                                                <div className="flex items-center gap-2 mb-4"><Zap className="w-6 h-6 text-amber-500" /><h3 className="text-lg font-bold text-amber-800">Recomendação</h3></div>
                                                <p className="text-sm text-amber-700 mb-6">Sugerimos ofertar:</p>
                                                <div className="space-y-3">
                                                    {clientDetail.recommendations.map((rec, i) => (
                                                        <div key={i} className="bg-white p-4 rounded-lg shadow-sm border border-amber-100 flex items-center justify-between group cursor-pointer hover:border-amber-300 transition-colors">
                                                            <div><p className="text-xs font-bold text-amber-500 uppercase">{rec.type}</p><p className="font-bold text-slate-700">{rec.name}</p></div>
                                                            <div className="bg-amber-100 p-2 rounded-full text-amber-600 group-hover:bg-amber-500 group-hover:text-white transition-colors"><ArrowRight className="w-4 h-4" /></div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MarketIntelligenceDashboard />);
    </script>
</body>
</html>
